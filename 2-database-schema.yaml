# WIZZO Database Schema
# Generated on March 26, 2025

database:
  provider: "Vercel Postgres"
  orm: "Drizzle ORM"
  migrations: 
    directory: "lib/db/migrations"
    command: "npx tsx lib/db/migrate.ts"

schema_overview:
  user_system: "Authentication and user profiles"
  chat_system: "Chat sessions, messages, and voting"
  document_system: "General document storage and suggestions"
  knowledge_base: "Knowledge document storage, chunking, and referencing"
  task_management: "Task projects, items, and labels"

user_system:
  tables:
    - table: "User"
      description: "Stores user authentication information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "email"
          type: "varchar(64)"
          description: "User email address"
          constraints: "NOT NULL, UNIQUE"
        - name: "password"
          type: "varchar(64)"
          description: "Hashed password"
          constraints: "NULLABLE"
      relationships:
        - "One-to-many with Chat"
        - "One-to-many with Document"
        - "One-to-many with KnowledgeDocument"
        - "One-to-many with task_project"
        - "One-to-many with task_item"
        - "One-to-many with task_label"

chat_system:
  tables:
    - table: "Chat"
      description: "Stores chat session information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL"
        - name: "title"
          type: "text"
          description: "Chat title"
          constraints: "NOT NULL"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id)"
        - name: "visibility"
          type: "varchar"
          description: "Chat visibility (public/private)"
          constraints: "NOT NULL, DEFAULT 'private', ENUM('public', 'private')"
      relationships:
        - "Many-to-one with User"
        - "One-to-many with Message"
        - "One-to-many with Vote"
    
    - table: "Message"
      description: "Stores individual messages in chat sessions"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "chatId"
          type: "uuid"
          description: "Foreign key to Chat table"
          constraints: "NOT NULL, REFERENCES Chat(id)"
        - name: "role"
          type: "varchar"
          description: "Message role (user/assistant)"
          constraints: "NOT NULL"
        - name: "content"
          type: "json"
          description: "Message content"
          constraints: "NOT NULL"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL"
      indexes:
        - name: "chat_id_idx"
          fields: ["chatId"]
          description: "For faster chat message retrieval"
        - name: "message_created_at_idx"
          fields: ["chatId", "createdAt"]
          description: "For faster message sorting by creation time"
      relationships:
        - "Many-to-one with Chat"
        - "One-to-many with Vote"
        - "One-to-many with KnowledgeReference"
    
    - table: "Vote"
      description: "Stores user feedback on messages"
      fields:
        - name: "chatId"
          type: "uuid"
          description: "Foreign key to Chat table"
          constraints: "NOT NULL, REFERENCES Chat(id)"
        - name: "messageId"
          type: "uuid"
          description: "Foreign key to Message table"
          constraints: "NOT NULL, REFERENCES Message(id)"
        - name: "isUpvoted"
          type: "boolean"
          description: "Upvote status"
          constraints: "NOT NULL"
      constraints:
        - "PRIMARY KEY (chatId, messageId)"
      relationships:
        - "Many-to-one with Chat"
        - "Many-to-one with Message"

document_system:
  tables:
    - table: "Document"
      description: "Stores document information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key part 1"
          constraints: "NOT NULL, DEFAULT random()"
        - name: "createdAt"
          type: "timestamp"
          description: "Primary key part 2"
          constraints: "NOT NULL"
        - name: "title"
          type: "text"
          description: "Document title"
          constraints: "NOT NULL"
        - name: "content"
          type: "text"
          description: "Document content"
          constraints: "NULLABLE"
        - name: "kind"
          type: "varchar"
          description: "Document type (text/code/image/sheet)"
          constraints: "NOT NULL, DEFAULT 'text', ENUM('text', 'code', 'image', 'sheet')"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id)"
      constraints:
        - "PRIMARY KEY (id, createdAt)"
      indexes:
        - name: "document_user_id_idx"
          fields: ["userId"]
          description: "For faster document retrieval by user"
        - name: "document_created_at_idx"
          fields: ["createdAt"]
          description: "For faster document sorting by creation time"
        - name: "document_kind_idx"
          fields: ["kind"]
          description: "For document type filtering"
      relationships:
        - "Many-to-one with User"
        - "One-to-many with Suggestion"
    
    - table: "Suggestion"
      description: "Stores suggestions for document edits"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "documentId"
          type: "uuid"
          description: "Foreign key to Document table (part 1)"
          constraints: "NOT NULL"
        - name: "documentCreatedAt"
          type: "timestamp"
          description: "Foreign key to Document table (part 2)"
          constraints: "NOT NULL"
        - name: "originalText"
          type: "text"
          description: "Original text being edited"
          constraints: "NOT NULL"
        - name: "suggestedText"
          type: "text"
          description: "Suggested replacement text"
          constraints: "NOT NULL"
        - name: "description"
          type: "text"
          description: "Description of the suggestion"
          constraints: "NULLABLE"
        - name: "isResolved"
          type: "boolean"
          description: "Resolution status"
          constraints: "NOT NULL, DEFAULT false"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id)"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL"
      constraints:
        - "FOREIGN KEY (documentId, documentCreatedAt) REFERENCES Document(id, createdAt)"
      relationships:
        - "Many-to-one with Document"
        - "Many-to-one with User"

knowledge_base:
  tables:
    - table: "KnowledgeDocument"
      description: "Stores knowledge document metadata"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id)"
        - name: "title"
          type: "text"
          description: "Document title"
          constraints: "NOT NULL"
        - name: "description"
          type: "text"
          description: "Document description"
          constraints: "NULLABLE"
        - name: "sourceType"
          type: "varchar"
          description: "Source type (text/url)"
          constraints: "NOT NULL, ENUM('text', 'url')"
        - name: "sourceUrl"
          type: "text"
          description: "Source URL if applicable"
          constraints: "NULLABLE"
        - name: "fileSize"
          type: "varchar(20)"
          description: "File size"
          constraints: "NULLABLE"
        - name: "fileType"
          type: "varchar(50)"
          description: "File type"
          constraints: "NULLABLE"
        - name: "status"
          type: "varchar"
          description: "Processing status"
          constraints: "NOT NULL, DEFAULT 'processing', ENUM('processing', 'completed', 'failed')"
        - name: "processingError"
          type: "text"
          description: "Error details if processing failed"
          constraints: "NULLABLE"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
        - name: "updatedAt"
          type: "timestamp"
          description: "Update timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      relationships:
        - "Many-to-one with User"
        - "One-to-many with KnowledgeChunk"
    
    - table: "KnowledgeChunk"
      description: "Stores chunks of knowledge documents with embeddings"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "documentId"
          type: "uuid"
          description: "Foreign key to KnowledgeDocument table"
          constraints: "NOT NULL, REFERENCES KnowledgeDocument(id) ON DELETE CASCADE"
        - name: "content"
          type: "text"
          description: "Chunk content"
          constraints: "NOT NULL"
        - name: "metadata"
          type: "json"
          description: "Additional metadata"
          constraints: "NULLABLE"
        - name: "chunkIndex"
          type: "varchar(20)"
          description: "Index within the document"
          constraints: "NOT NULL"
        - name: "embedding"
          type: "text"
          description: "Vector embedding as JSON string"
          constraints: "NULLABLE"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      indexes:
        - name: "documentId_idx"
          fields: ["documentId"]
          description: "For faster chunk retrieval by document"
      relationships:
        - "Many-to-one with KnowledgeDocument"
        - "One-to-many with KnowledgeReference"
    
    - table: "KnowledgeReference"
      description: "Links chunks to chat messages"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "messageId"
          type: "uuid"
          description: "Foreign key to Message table"
          constraints: "NOT NULL, REFERENCES Message(id) ON DELETE CASCADE"
        - name: "chunkId"
          type: "uuid"
          description: "Foreign key to KnowledgeChunk table"
          constraints: "NOT NULL, REFERENCES KnowledgeChunk(id) ON DELETE CASCADE"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      indexes:
        - name: "message_chunk_idx"
          fields: ["messageId", "chunkId"]
          description: "For faster reference lookup"
      relationships:
        - "Many-to-one with Message"
        - "Many-to-one with KnowledgeChunk"

task_management:
  tables:
    - table: "task_project"
      description: "Stores task project information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id) ON DELETE CASCADE"
        - name: "name"
          type: "text"
          description: "Project name"
          constraints: "NOT NULL"
        - name: "color"
          type: "varchar(20)"
          description: "Project color"
          constraints: "NOT NULL, DEFAULT '#808080'"
        - name: "isDefault"
          type: "boolean"
          description: "Default project flag"
          constraints: "NOT NULL, DEFAULT false"
        - name: "isDeleted"
          type: "boolean"
          description: "Deletion flag"
          constraints: "NOT NULL, DEFAULT false"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
        - name: "updatedAt"
          type: "timestamp"
          description: "Update timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      relationships:
        - "Many-to-one with User"
        - "One-to-many with task_item"
    
    - table: "task_item"
      description: "Stores individual task information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id) ON DELETE CASCADE"
        - name: "projectId"
          type: "uuid"
          description: "Foreign key to task_project table"
          constraints: "NOT NULL, REFERENCES task_project(id) ON DELETE CASCADE"
        - name: "content"
          type: "text"
          description: "Task content"
          constraints: "NOT NULL"
        - name: "description"
          type: "text"
          description: "Task description"
          constraints: "NULLABLE"
        - name: "completed"
          type: "boolean"
          description: "Completion status"
          constraints: "NOT NULL, DEFAULT false"
        - name: "priority"
          type: "varchar"
          description: "Priority level (p1-p4)"
          constraints: "NOT NULL, DEFAULT 'p4', ENUM('p1', 'p2', 'p3', 'p4')"
        - name: "dueDate"
          type: "varchar(50)"
          description: "Due date"
          constraints: "NULLABLE"
        - name: "isDeleted"
          type: "boolean"
          description: "Deletion flag"
          constraints: "NOT NULL, DEFAULT false"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
        - name: "updatedAt"
          type: "timestamp"
          description: "Update timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      indexes:
        - name: "project_id_idx"
          fields: ["projectId"]
          description: "For faster task retrieval by project"
        - name: "user_id_idx"
          fields: ["userId"]
          description: "For faster task retrieval by user"
      relationships:
        - "Many-to-one with User"
        - "Many-to-one with task_project"
        - "Many-to-many with task_label through task_item_label"
    
    - table: "task_label"
      description: "Stores task label information"
      fields:
        - name: "id"
          type: "uuid"
          description: "Primary key"
          constraints: "PRIMARY KEY, NOT NULL, DEFAULT random()"
        - name: "userId"
          type: "uuid"
          description: "Foreign key to User table"
          constraints: "NOT NULL, REFERENCES User(id) ON DELETE CASCADE"
        - name: "name"
          type: "text"
          description: "Label name"
          constraints: "NOT NULL"
        - name: "color"
          type: "varchar(20)"
          description: "Label color"
          constraints: "NOT NULL, DEFAULT '#808080'"
        - name: "isDeleted"
          type: "boolean"
          description: "Deletion flag"
          constraints: "NOT NULL, DEFAULT false"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
        - name: "updatedAt"
          type: "timestamp"
          description: "Update timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      relationships:
        - "Many-to-one with User"
        - "Many-to-many with task_item through task_item_label"
    
    - table: "task_item_label"
      description: "Links tasks to labels (many-to-many)"
      fields:
        - name: "taskId"
          type: "uuid"
          description: "Foreign key to task_item table"
          constraints: "NOT NULL, REFERENCES task_item(id) ON DELETE CASCADE"
        - name: "labelId"
          type: "uuid"
          description: "Foreign key to task_label table"
          constraints: "NOT NULL, REFERENCES task_label(id) ON DELETE CASCADE"
        - name: "createdAt"
          type: "timestamp"
          description: "Creation timestamp"
          constraints: "NOT NULL, DEFAULT NOW()"
      constraints:
        - "PRIMARY KEY (taskId, labelId)"
      indexes:
        - name: "task_id_idx"
          fields: ["taskId"]
          description: "For faster label lookup by task"
        - name: "label_id_idx"
          fields: ["labelId"]
          description: "For faster task lookup by label"
      relationships:
        - "Many-to-one with task_item"
        - "Many-to-one with task_label"

database_migrations:
  setup_commands:
    - "pnpm db:generate"
    - "pnpm db:migrate"
    - "pnpm db:push"
  
  maintenance_commands:
    - "pnpm db:check"
    - "pnpm fix:database"
    - "pnpm fix:knowledge"
    - "pnpm fix:vector-search"
  
  utilities:
    - "pnpm db:studio"
    - "pnpm diagnose:schema"
